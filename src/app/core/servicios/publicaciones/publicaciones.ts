import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { Observable, catchError, of, tap } from 'rxjs';

// Interfaces
export interface Publicacion {
  id: number;
  usuario_id: number;
  contenido: string;
  imagen_url?: string;
  imagen_s3?: string;
  categoria?: string;
  color_categoria?: string;
  nombre_usuario?: string;
  nombre_completo?: string;
  foto_perfil_url?: string;
  fecha_creacion: string;
  oculto: number;
}

export interface Categoria {
  value: string;
  label: string;
  color: string;
}

export interface ApiResponse<T> {
  success: boolean;
  data: T;
  message: string;
  mensaje?: string; // Para compatibilidad con backend
}

@Injectable({
  providedIn: 'root'
})
export class PublicacionesService {
  private apiUrl: string;

  constructor(private http: HttpClient) {
    const host = window.location.hostname;
    this.apiUrl = host === 'localhost' || host === '127.0.0.1'
      ? 'http://localhost:3000/api/publicaciones'
      : 'http://13.59.190.199:3000/api/publicaciones';
    
    console.log('üîß PublicacionesService inicializado');
    console.log('üìç API URL:', this.apiUrl);
  }

  // Construir headers con token
  private getHeaders(): { headers?: HttpHeaders } {
    const token = localStorage.getItem('token');
    
    if (token) {
      console.log('üîë Token encontrado, agregando a headers');
      return { 
        headers: new HttpHeaders({ 
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }) 
      };
    }
    
    console.log('‚ö†Ô∏è No hay token, request sin autenticaci√≥n');
    return {};
  }

  // ‚úÖ Obtener categor√≠as disponibles
  obtenerCategorias(): Observable<ApiResponse<Categoria[]>> {
    console.log('üìÇ Obteniendo categor√≠as...');
    return this.http.get<ApiResponse<Categoria[]>>(`${this.apiUrl}/categorias`).pipe(
      tap(response => console.log('‚úÖ Categor√≠as obtenidas:', response)),
      catchError(error => {
        console.error('‚ùå Error al obtener categor√≠as:', error);
        // Devolver categor√≠as por defecto si falla
        return of({
          success: true,
          data: this.getCategoriasDefault(),
          message: 'Categor√≠as por defecto'
        });
      })
    );
  }

  // Crear publicaci√≥n
  crearPublicacion(publicacion: FormData): Observable<ApiResponse<Publicacion>> {
    console.log('üìù Creando publicaci√≥n...');
    
    // Para FormData no usar Content-Type en headers
    const token = localStorage.getItem('token');
    const headers = token ? { headers: new HttpHeaders({ 'Authorization': `Bearer ${token}` }) } : {};
    
    return this.http.post<ApiResponse<Publicacion>>(this.apiUrl, publicacion, headers).pipe(
      tap(response => console.log('‚úÖ Publicaci√≥n creada:', response)),
      catchError(error => {
        console.error('‚ùå Error al crear publicaci√≥n:', error);
        throw error;
      })
    );
  }

  // Obtener feed general - CON MEJOR MANEJO DE ERRORES
  obtenerPublicaciones(): Observable<ApiResponse<Publicacion[]>> {
    console.log('üîÑ Obteniendo publicaciones...');
    console.log('üì° URL:', this.apiUrl);
    
    const headers = this.getHeaders();
    console.log('üì§ Headers:', headers);
    
    return this.http.get<ApiResponse<Publicacion[]>>(this.apiUrl, headers).pipe(
      tap(response => {
        console.log('‚úÖ Respuesta recibida:', {
          success: response.success,
          cantidad: response.data?.length || 0,
          mensaje: response.message || response.mensaje
        });
      }),
      catchError(error => {
        console.error('‚ùå Error al obtener publicaciones:', {
          status: error.status,
          statusText: error.statusText,
          mensaje: error.error?.mensaje || error.message,
          url: error.url
        });
        
        // En lugar de fallar, devolver respuesta vac√≠a para que el componente maneje
        return of({
          success: false,
          data: [],
          message: error.error?.mensaje || 'Error al cargar publicaciones'
        });
      })
    );
  }

  // Obtener publicaci√≥n por ID
  obtenerPublicacion(id: number): Observable<ApiResponse<Publicacion>> {
    console.log('üîç Obteniendo publicaci√≥n ID:', id);
    return this.http.get<ApiResponse<Publicacion>>(`${this.apiUrl}/${id}`, this.getHeaders()).pipe(
      tap(response => console.log('‚úÖ Publicaci√≥n obtenida:', response)),
      catchError(error => {
        console.error('‚ùå Error al obtener publicaci√≥n:', error);
        throw error;
      })
    );
  }

  // Obtener mis publicaciones
  obtenerMisPublicaciones(): Observable<ApiResponse<Publicacion[]>> {
    console.log('üë§ Obteniendo mis publicaciones...');
    return this.http.get<ApiResponse<Publicacion[]>>(`${this.apiUrl}/mis-publicaciones`, this.getHeaders()).pipe(
      tap(response => console.log('‚úÖ Mis publicaciones:', response.data?.length || 0)),
      catchError(error => {
        console.error('‚ùå Error al obtener mis publicaciones:', error);
        throw error;
      })
    );
  }

  // Obtener publicaciones de otro usuario
  obtenerPublicacionesUsuario(usuarioId: number): Observable<ApiResponse<Publicacion[]>> {
    console.log('üë• Obteniendo publicaciones del usuario:', usuarioId);
    return this.http.get<ApiResponse<Publicacion[]>>(`${this.apiUrl}/usuario/${usuarioId}`, this.getHeaders()).pipe(
      tap(response => console.log('‚úÖ Publicaciones del usuario:', response.data?.length || 0)),
      catchError(error => {
        console.error('‚ùå Error al obtener publicaciones del usuario:', error);
        throw error;
      })
    );
  }

  // Actualizar publicaci√≥n
  actualizarPublicacion(id: number, publicacion: FormData): Observable<ApiResponse<Publicacion>> {
    console.log('‚úèÔ∏è Actualizando publicaci√≥n ID:', id);
    
    const token = localStorage.getItem('token');
    const headers = token ? { headers: new HttpHeaders({ 'Authorization': `Bearer ${token}` }) } : {};
    
    return this.http.put<ApiResponse<Publicacion>>(`${this.apiUrl}/${id}`, publicacion, headers).pipe(
      tap(response => console.log('‚úÖ Publicaci√≥n actualizada:', response)),
      catchError(error => {
        console.error('‚ùå Error al actualizar publicaci√≥n:', error);
        throw error;
      })
    );
  }

  // Eliminar publicaci√≥n
  eliminarPublicacion(id: number): Observable<ApiResponse<null>> {
    console.log('üóëÔ∏è Eliminando publicaci√≥n ID:', id);
    return this.http.delete<ApiResponse<null>>(`${this.apiUrl}/${id}`, this.getHeaders()).pipe(
      tap(response => console.log('‚úÖ Publicaci√≥n eliminada:', response)),
      catchError(error => {
        console.error('‚ùå Error al eliminar publicaci√≥n:', error);
        throw error;
      })
    );
  }

  // Helper: Crear FormData
  crearFormData(datos: {
    contenido: string;
    categoria?: string;
    imagen?: File;
  }): FormData {
    const formData = new FormData();
    formData.append('contenido', datos.contenido);
    if (datos.categoria) formData.append('categoria', datos.categoria);
    if (datos.imagen) formData.append('imagen', datos.imagen);
    
    console.log('üì¶ FormData creado:', {
      contenido: datos.contenido.substring(0, 50) + '...',
      categoria: datos.categoria,
      tieneImagen: !!datos.imagen
    });
    
    return formData;
  }

  // Helper: Obtener el color de una categor√≠a
  obtenerColorCategoria(categoria: string): string {
    const colores: { [key: string]: string } = {
      'General': 'bg-orange-500',
      'Tecnolog√≠a': 'bg-teal-500',
      'Ciencias': 'bg-purple-500',
      'Artes y Cultura': 'bg-pink-500',
      'Deportes': 'bg-blue-500',
      'Salud y Bienestar': 'bg-green-500',
      'Vida Universitaria': 'bg-orange-600',
      'Opini√≥n': 'bg-indigo-500',
      'Entrevistas': 'bg-yellow-500'
    };
    return colores[categoria] || 'bg-orange-500';
  }

  // Helper privado: Categor√≠as por defecto
  private getCategoriasDefault(): Categoria[] {
    return [
      { value: 'General', label: 'General', color: 'bg-orange-500' },
      { value: 'Tecnolog√≠a', label: 'Tecnolog√≠a', color: 'bg-teal-500' },
      { value: 'Ciencias', label: 'Ciencias', color: 'bg-purple-500' },
      { value: 'Artes y Cultura', label: 'Artes y Cultura', color: 'bg-pink-500' },
      { value: 'Deportes', label: 'Deportes', color: 'bg-blue-500' },
      { value: 'Salud y Bienestar', label: 'Salud y Bienestar', color: 'bg-green-500' },
      { value: 'Vida Universitaria', label: 'Vida Universitaria', color: 'bg-orange-600' },
      { value: 'Opini√≥n', label: 'Opini√≥n', color: 'bg-indigo-500' },
      { value: 'Entrevistas', label: 'Entrevistas', color: 'bg-yellow-500' }
    ];
  }

  // Helper: Verificar conectividad con el backend
  verificarConexion(): Observable<boolean> {
    console.log('üîå Verificando conexi√≥n con backend...');
    return this.http.get<ApiResponse<Categoria[]>>(`${this.apiUrl}/categorias`).pipe(
      tap(() => console.log('‚úÖ Backend accesible')),
      catchError(error => {
        console.error('‚ùå Backend no accesible:', error);
        return of(false as any);
      })
    ) as Observable<boolean>;
  }
}